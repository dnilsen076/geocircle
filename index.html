<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Washoe Safe Shot - GPS Shooting Checker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 20px; font-family: Arial, sans-serif; text-align: center; background: #f4f4f4; }
        #map { height: 60vh; margin: 20px auto; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        button { background: #007bff; color: white; padding: 16px; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; width: 90%; max-width: 400px; margin: 10px; }
        button:hover { background: #0056b3; }
        #status { margin: 15px; font-size: 16px; color: #555; }
        #verdict { font-size: 20px; font-weight: bold; margin: 20px; padding: 15px; border-radius: 8px; }
        .legal { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .illegal { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .rules { background: #e9ecef; padding: 10px; margin: 10px; border-radius: 8px; text-align: left; }
    </style>
</head>
<body>
    <h1>üéØ Washoe Safe Shot</h1>
    <p><strong>USMC Vet Project | Built with Grok xAI</strong></p>
    <p><a href="https://www.washoecounty.gov/clerks/cco/code/Chapter050.pdf" target="_blank">Washoe County Code 50</a></p>

    <div class="rules">
        <h3>üìã Quick Rules</h3>
        <ul>
            <li>Rifles/Pistols: >5,000 ft from dwellings</li>
            <li>Shotguns/BB/Air: >1,000 ft from dwellings</li>
            <li>NO: Congested areas, roads, parks</li>
            <li>Report illegal: 775-785-9276</li>
        </ul>
        <p><a href="https://www.washoesheriff.com" target="_blank">Sheriff's Page</a></p>
    </div>

    <p id="status">Tap button to get your GPS location</p>
    <button onclick="getLocation()">üìç Get My GPS Location</button>

    <div id="map"></div>

    <button onclick="checkLegality()">üéØ Check Legality</button>
    <div id="verdict"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map;
        let userLat, userLon;
        let buildings = [];

        // Initialize map
        function initMap() {
            map = L.map('map').setView([39.72009, -119.92786], 16);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            L.marker([39.72009, -119.92786]).addTo(map).bindPopup('Default Location - Get GPS for accuracy');
        }

        // Get GPS
        function getLocation() {
            const status = document.getElementById('status');
            status.innerHTML = 'Getting your location...';
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLat = position.coords.latitude;
                        userLon = position.coords.longitude;
                        status.innerHTML = `GPS Locked: ${userLat.toFixed(5)}¬∞, ${userLon.toFixed(5)}¬∞`;
                        map.setView([userLat, userLon], 16);
                        L.marker([userLat, userLon]).addTo(map).bindPopup('Your Location').openPopup();
                    },
                    (error) => {
                        status.innerHTML = 'Error getting location: ' + error.message;
                    },
                    {enableHighAccuracy: true, timeout: 15000}
                );
            } else {
                status.innerHTML = 'Geolocation not supported';
            }
        }

        // Check legality
        async function checkLegality() {
            if (!userLat || !userLon) {
                document.getElementById('verdict').innerHTML = '<div class="illegal">Get GPS first!</div>';
                return;
            }

            const status = document.getElementById('status');
            status.innerHTML = 'Scanning for buildings...';

            // Query Overpass API for buildings around user
            const query = `[out:json][timeout:25];(way["building"](around:20000,${userLat},${userLon}););out center;`;
            try {
                const response = await fetch('https://overpass-api.de/api/interpreter?data=' + encodeURIComponent(query));
                const data = await response.json();

                let minDist = Infinity;
                buildings = [];
                data.elements.forEach(el => {
                    if ('center' in el) {
                        const bLat = el.center.lat;
                        const bLon = el.center.lon;
                        const dist = getDistance(userLat, userLon, bLat, bLon) * 3.28084; // meters to feet
                        buildings.push({lat: bLat, lon: bLon, dist: dist});
                        if (dist < minDist) minDist = dist;
                    }
                });

                // Add buildings to map
                map.eachLayer(layer => {
                    if (layer instanceof L.Marker && layer.getPopup().getContent() !== 'Your Location') {
                        map.removeLayer(layer);
                    }
                });
                buildings.slice(0, 20).forEach(b => { // Show top 20 closest
                    L.marker([b.lat, b.lon]).addTo(map).bindPopup(`Building ${b.dist.toFixed(0)} ft away`);
                });

                // Verdict
                const verdict = document.getElementById('verdict');
                if (minDist === Infinity) {
                    verdict.innerHTML = '<div class="legal">‚úÖ REMOTE AREA - Legal for all firearms</div>';
                } else if (minDist > 5000) {
                    verdict.innerHTML = '<div class="legal">‚úÖ LEGAL: Rifles/Pistols/ALL (>5,000 ft)</div>';
                } else if (minDist > 1000) {
                    verdict.innerHTML = '<div class="warning">‚ö†Ô∏è LEGAL: Shotguns/BB/Air ONLY (>1,000 ft)</div>';
                } else {
                    verdict.innerHTML = '<div class="illegal">üö´ ILLEGAL - TOO CLOSE (<1,000 ft)</div>';
                }
                verdict.innerHTML += `<p>Nearest building: ${minDist.toFixed(0)} ft</p>`;
                status.innerHTML = 'Check complete!';
            } catch (error) {
                document.getElementById('verdict').innerHTML = '<div class="illegal">Error checking: ' + error.message + '</div>';
                status.innerHTML = 'Error occurred';
            }
        }

        // Distance function (haversine)
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth's radius in meters
            const œÜ1 = lat1 * Math.PI/180;
            const œÜ2 = lat2 * Math.PI/180;
            const ŒîœÜ = (lat2-lat1) * Math.PI/180;
            const ŒîŒª = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                      Math.cos(œÜ1) * Math.cos(œÜ2) *
                      Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Init
        initMap();
    </script>
</body>
</html>
